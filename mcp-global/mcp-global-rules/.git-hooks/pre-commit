#!/bin/bash
# MCP Pre-commit Hook - ENHANCED
# Maximum automation with learning and verification
set -e

echo ""
echo "======================================================"
echo "[MCP] PRE-COMMIT: Maximum automation engaged"
echo "======================================================"

# Detect Python
if [ -f "./.venv/Scripts/python" ]; then
    PYTHON_CMD="./.venv/Scripts/python"
elif [ -f "./.venv/bin/python" ]; then
    PYTHON_CMD="./.venv/bin/python"
else
    PYTHON_CMD="python"
fi

# Find mcp.py path
if [ -f "mcp-global-rules/mcp.py" ]; then
    MCP="mcp-global-rules/mcp.py"
elif [ -f "mcp-global/mcp-global-rules/mcp.py" ]; then
    MCP="mcp-global/mcp-global-rules/mcp.py"
else
    echo "[MCP] Warning: mcp.py not found"
    exit 0
fi

# Record that pre-commit ran (for bypass detection)
$PYTHON_CMD $MCP hook-guardian --record-pre-commit

echo ""
echo "[MCP] Running quality checks..."
echo "------------------------------------------------------"

# Auto-fix safe issues
echo "[1/5] Auto-fixing safe issues..."
$PYTHON_CMD $MCP fix . --safe --apply 2>/dev/null || true

# Bug prediction
echo "[2/5] Predicting bugs..."
$PYTHON_CMD $MCP predict-bugs . 2>/dev/null || true

# Security scan
echo "[3/5] Security scan..."
$PYTHON_CMD $MCP security . 2>/dev/null || true

# Code review
echo "[4/5] Code review..."
$PYTHON_CMD $MCP review . --strict 2>/dev/null || true

# Record file access patterns for learning
echo "[5/5] Recording patterns for learning..."
$PYTHON_CMD $MCP auto-learn --pre-commit 2>/dev/null || true

echo ""
echo "[MCP] Pre-commit checks complete"
echo "======================================================"
